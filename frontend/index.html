<html>
<head>
    <link rel="stylesheet" href="style.css" />
    <script src="/src/lib/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
    $(document).ready(function() {
        var current_phrase = -1;
        var phrases = [];
        var socket;

        var smoothness = 50;
        var refresh_delay = 10 * smoothness;
        var refresh_countdown = refresh_delay;
        
        var quote_lifetime = 60 * 60 * 24;

        function init_socket() {
            socket = io.connect('/');
            
            //simple phrase addition, add it to our list
            socket.on('add_phrase', function(data) {
                add_phrase(data);
            });

            //response to an earlier bootstrap call, set all phrases
            socket.on('set_all_phrases', function(data) {
                phrases = data;
                retire_old_phrases();
                refresh_phrases();
            });

            //a request for all of our phrases, return them
            socket.on('get_phrases', function() {
                socket.emit('all_phrases', phrases);
            });

            socket.on('num_clients', function(data) {
                update_number_of_clients(data.count);
            });

            //request our own bootstrapping
            socket.emit('bootstrap');

            window.setInterval(countdown_to_refresh, 1000 / smoothness);
        }
        
        function add_phrase(phrase) {
            phrases.push(phrase);
            if (phrases.length == 1) {
                refresh_phrases();
            }
            update_phrase_count();
        }

        function countdown_to_refresh() {
            if (phrases.length <= 1) {
                return;
            }
        
            refresh_countdown--;
            if (refresh_countdown <= 0) {
                refresh_phrases();
            } else {
                update_countdown_plunger();
            }
        }

        function update_countdown_plunger() {
            var pct = (refresh_countdown * 100) / refresh_delay;
            $('#plunger').width(pct + '%');
        }

        function refresh_phrases() {
            if (phrases.length == 0) {
                return;
            }
            
            current_phrase++;
            if (current_phrase >= phrases.length) {
                retire_old_phrases();
                current_phrase = 0;
            }

            draw_current_phrase();

            refresh_countdown = refresh_delay;
            update_countdown_plunger();
        }

        function retire_old_phrases() {
            var cutoff = 1000 * quote_lifetime;

            var dt = new Date();
            var now = dt.getTime();
            var num_removed = 0;
            phrases = phrases.filter(function(phrase, index, list) {
                //always leave one item in the list
                if (phrases.length - num_removed == 1) {
                    return true;
                }

                if (phrase.created_time == undefined) {
                    return false;
                }

                if (phrase.created_time < now - cutoff) {
                    num_removed++;
                    return false;
                }
                return true;
            });
            
            update_phrase_count();
        }

        function update_number_of_clients(count) {
            $('#client_count').text(count);
        }
        
        function update_phrase_count() {
            $('#phrase_count').text(phrases.length);
        }

        function draw_current_phrase() {
            var phrase = phrases[current_phrase];
            
            $('#current_id').text(current_phrase + 1);
            $('#phrase').text(phrase.phrase);
            $('#author').text(phrase.author);
        }

        function init_form() {
            $('#add_phrase_button').click(function() {
                var phrase = $('#phrase_input').val();
                var author = $('#author_input').val();
                $('#phrase_input').val('');
                $('#author_input').val('');

                var dt = new Date();
                var now = dt.getTime();
                var phraseobj = {
                    phrase: phrase,
                    author: author,
                    created_time: now };
                add_phrase(phraseobj);
                socket.emit('new_phrase', phraseobj);
            });
            
            $('#show_next').click(function() {
                refresh_phrases();
            });
        }

        init_socket();
        init_form();
    });
    </script>
</head>
<body>
    <div id="header">
        <label for="phrase_input">Phrase: </label>
        <input type="text" id="phrase_input" size="30" />
        <label for="author_input">Author: </label>
        <input type="text" id="author_input" size="15" />
        <input type="button" id="add_phrase_button" value="Add Phrase" />
        <span id="sep"></span>
        Phrase <span id="current_id"></span>/<span id="phrase_count"></span>
        <input type="button" id="show_next" value="Next" />
        | <label for="client_count">Clients:</label>
        <span id="client_count"></span>
    </div>
    <div id="countdown"><div id="plunger"></div></div>
    <div id="phrase_box">
        <div id="phrase"></div>
        <div id="author"></div>
    </div>
</body>
</html>

